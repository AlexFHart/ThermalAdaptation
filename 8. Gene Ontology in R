# this is a general script for performing GO term enrichment from gene lists generated by edgeR analysis

# setup
library(dplyr)
library(tibble)
library(stringr)
library(GOstats)
library("GSEABase")

# universe is a file containing the gene/transcript IDs for every feature in the genome, and the associated GO ID and function, if any.
universe <- read.csv("~/Library/Mobile Documents/com~apple~CloudDocs/Documents/PostDoc Folder/Scripts & Code/ThermAdapt/VectorAnalysis/whole_universe.csv")

setwd("~/Library/Mobile Documents/com~apple~CloudDocs/Documents/PostDoc Folder/Scripts & Code/ThermAdapt/2025/WCGNA/new results/setcut")
# reclass is a list of the genes of interest, with a column/factor separating different lists, e.g "hot", "cold", plus GO ID (which I made with inner_join previously)
reclass <- read.csv("all_samples_function_summary.csv") 

# setting up the reftable: three columns: gene ID, GO ID, evidence
AnGo <- read.table("~/Library/Mobile Documents/com~apple~CloudDocs/Documents/PostDoc Folder/Scripts & Code/ThermAdapt/VectorAnalysis/scrapped/GO Analysis Results/old_Anno_GO.csv", sep = ",", header = TRUE)

goframeData <- data.frame(AnGo$value, AnGo$Evidence, AnGo$New_ID)
goFrame = GOFrame(goframeData,organism="Callosobruchus maculatus") # just tags it as a GO frame object
goAllFrame = GOAllFrame(goFrame) # more formatting i think, linking GO terms/categories
gsc <- GeneSetCollection(goAllFrame, setType = GOCollection()) # standardising gene set collections

# setting up the lists
conting <- reclass[,2:3]

# processing
module_list <- c("black", "blue", "brown", "green", "grey", "red", "turquoise", "yellow")

processor <- function(mod) {
  # pre-processing
  name <- substitute(mod)
  name <- unique(conting %>% filter(netwk.colors == name))
  name <- as.data.frame(name[,1])
  colnames(name) <- c("GeneID")
  
  # attach to universe
  name <- inner_join(name, universe, by = c('GeneID' = 'Genomic_ID'))
  name <- as.data.frame(name$Transcript_ID)
  
  return(name)
} # this will need adjusting if you need to return to just pure lists

# there's probably a smarter way to do this, but everything needs renaming or it won't work
black <- processor(black)
colnames(black) <- c("black")
blue <- processor(blue)
colnames(blue) <- c("blue")
brown <- processor(brown)
colnames(brown) <- c("brown")
green <- processor(green)
colnames(green) <- c("green")
grey <- processor(grey)
colnames(grey) <- c("grey")
red <- processor(red)
colnames(red) <- c("red")
turquoise <- processor(turquoise)
colnames(turquoise) <- c("turquoise")
yellow <- processor(yellow)
colnames(yellow) <- c("yellow")

to_do_list <- c(black, blue, brown, green, grey, red, turquoise, yellow)

# running GO

for (item in 1:length(to_do_list)) {
  namae = names(to_do_list[item])
  namae2 <- strsplit(namae,split = '\\$')
  namae3 <- namae2[[1]][1]
  
  list_of_interest <- to_do_list[item]

  bp_params <- GSEAGOHyperGParams(name="GO bp",
                                  geneSetCollection=gsc,
                                  geneIds = list_of_interest,
                                  universeGeneIds = AnGo$New_ID,
                                  ontology = "BP",
                                  pvalueCutoff = 1,
                                  conditional = FALSE,
                                  testDirection = "over")

  bp_test <- hyperGTest(bp_params)
  bp <- summary(bp_test)

  mf_params <- GSEAGOHyperGParams(name="GO mf",
                                  geneSetCollection=gsc,
                                  geneIds = list_of_interest,
                                  universeGeneIds = AnGo$New_ID,
                                  ontology = "MF",
                                  pvalueCutoff = 1,
                                  conditional = FALSE,
                                  testDirection = "over")

  mf_test <- hyperGTest(mf_params)
  mf <- summary(mf_test)

  cc_params <- GSEAGOHyperGParams(name="GO cc",
                                  geneSetCollection=gsc,
                                  geneIds = list_of_interest,
                                  universeGeneIds = AnGo$New_ID,
                                  ontology = "CC",
                                  pvalueCutoff = 1,
                                  conditional = FALSE,
                                  testDirection = "over")

  cc_test <- hyperGTest(cc_params)
  cc <- summary(cc_test)


  write.csv(bp, paste0(namae3, '_bp.csv'), row.names = FALSE)
  write.csv(mf, paste0(namae3, '_mf.csv'), row.names = FALSE)
  write.csv(cc, paste0(namae3, '_cc.csv'), row.names = FALSE)
  
}



# bonus code: some examples Bonferroni correction of p-vals

setwd("~/Library/Mobile Documents/com~apple~CloudDocs/Documents/PostDoc Folder/Scripts & Code/ThermAdapt/VectorAnalysis")
setwd("~/Documents/Alex/github/ThermAdapt/VectorAnalysis")

# all DEG lists 
grand_list <- read.csv("grand_list.csv")

hs_all_up <- as.data.frame(grand_list$HS_all_up)
mr_all_up <- as.data.frame(grand_list$MR_all_up)
hs_all_down <- as.data.frame(grand_list$HS_all_down)
mr_all_down <- as.data.frame(grand_list$MR_all_down)
overlap_antags <- as.data.frame(grand_list$overlap_all_antags)


hs_up <- inner_join(hs_all_up, universe, by = c("grand_list$HS_all_up" = "Genomic_ID"))
hs_down <- inner_join(hs_all_down, universe, by = c("grand_list$HS_all_down" = "Genomic_ID"))
mr_up <- inner_join(mr_all_up, universe, by = c("grand_list$MR_all_up" = "Genomic_ID"))
mr_down <- inner_join(mr_all_down, universe, by = c("grand_list$MR_all_down" = "Genomic_ID"))
antags <- inner_join(overlap_antags, universe, by = c("grand_list$overlap_all_antags" = "Genomic_ID"))

un <- read.csv("pre_adjust.csv")

p_hs_up <- un$hs_up
p_hs_down <- un$hs_down
p_mr_up <- un$mr_up
p_mr_down <- un$mr_down
p_antags <- un$antags # the NAs do not affect test results but their removal does make it harder to glue things together for a data frame later

a_hs_up <- p.adjust(p_hs_up, method = "BH", n = 634) # how did i get this number? the no. of genes in the list x the no. of unique GO terms in that list
a_hs_down <- p.adjust(p_hs_down, method = "BH", n = 457)
a_mr_up <- p.adjust(p_mr_up, method = "BH", n = 719)
a_mr_down <- p.adjust(p_mr_down, method = "BH", n = 750)
a_antags <- p.adjust(p_antags, method = "BH", n = 302)

adjusted <- data.frame(a_hs_up, a_hs_down, a_mr_up, a_mr_down, a_antags)





